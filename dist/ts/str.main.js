(()=>{var B=document.getElementById("msg_send"),E=document.getElementById("status_bar"),oe=document.getElementById("msg_input"),H=document.getElementById("chat_inner_div"),m=document.getElementById("msg_container"),L=document.getElementById("servers_div"),ae=document.getElementById("info_floater"),j=document.getElementById("serveradd"),ce=document.getElementById("typing"),N=document.getElementById("chat_div"),le=document.getElementById("css"),f=document.getElementById("settings_menu"),U=document.getElementById("settings_button");var A=class e{static version=1;id;other_key;self_keys;constructor(t,n,r){this.id=t,this.other_key=n,this.self_keys=r}async encrypt(t){let n=new TextEncoder().encode(t);return await window.crypto.subtle.encrypt({name:"RSA-OAEP"},this.other_key,n)}async decrypt(t){let n=await window.crypto.subtle.decrypt({name:"RSA-OAEP"},this.self_keys.privateKey,t);return new TextDecoder().decode(n)}async serialize(){return{version:e.version,id:this.id,other_key:btoa(String.fromCharCode(...new Uint8Array(await window.crypto.subtle.exportKey("spki",this.other_key)))),self_keys:{publicKey:btoa(String.fromCharCode(...new Uint8Array(await window.crypto.subtle.exportKey("spki",this.self_keys.publicKey)))),privateKey:btoa(String.fromCharCode(...new Uint8Array(await window.crypto.subtle.exportKey("pkcs8",this.self_keys.privateKey))))}}}static async deserialize(t){if(t.version!==e.version)throw new Error("Incompatible crypto_session version");let n=Uint8Array.from(atob(t.other_key),l=>l.charCodeAt(0)),r=await window.crypto.subtle.importKey("spki",n.buffer,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),s=Uint8Array.from(atob(t.self_keys.publicKey),l=>l.charCodeAt(0)),i=Uint8Array.from(atob(t.self_keys.privateKey),l=>l.charCodeAt(0)),o=await window.crypto.subtle.importKey("spki",s.buffer,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),c=await window.crypto.subtle.importKey("pkcs8",i.buffer,{name:"RSA-OAEP",hash:"SHA-256"},!0,["decrypt"]),a={publicKey:o,privateKey:c};return new e(t.id,r,a)}};async function Y(){let e=await window.crypto.subtle.generateKey({name:"RSA-OAEP",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:"SHA-256"},!0,["encrypt","decrypt"]),t=await window.crypto.subtle.exportKey("spki",e.publicKey),n=await window.crypto.subtle.exportKey("pkcs8",e.privateKey);return console.log("Public Key:",btoa(String.fromCharCode(...new Uint8Array(t)))),console.log("Private Key:",btoa(String.fromCharCode(...new Uint8Array(n)))),{publicKey:t,privateKey:n,keyPair:e}}var w=class e{static version=1;self_keys;sessions={};constructor(t){this.self_keys=t}static async init(){let{keyPair:t}=await Y();return new e(t)}get_session(t){return t in this.sessions?this.sessions[t]:null}add_session(t,n){if(t in this.sessions)return this.sessions[t];let r=Uint8Array.from(atob(n),s=>s.charCodeAt(0));return window.crypto.subtle.importKey("spki",r.buffer,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]).then(s=>{let i=new A(t,s,this.self_keys);return this.sessions[t]=i,i})}async decrypt(t){let n=await window.crypto.subtle.decrypt({name:"RSA-OAEP"},this.self_keys.privateKey,t);return new TextDecoder().decode(n)}async serialize(){let t={};for(let[n,r]of Object.entries(this.sessions))t[n]=r.serialize();return{version:e.version,self_keys:{publicKey:btoa(String.fromCharCode(...new Uint8Array(await window.crypto.subtle.exportKey("spki",this.self_keys.publicKey)))),privateKey:btoa(String.fromCharCode(...new Uint8Array(await window.crypto.subtle.exportKey("pkcs8",this.self_keys.privateKey))))},sessions:t}}static async deserialize(t){if(t.version!==e.version)throw new Error("Incompatible crypto_manager version");let n=Uint8Array.from(atob(t.self_keys.publicKey),a=>a.charCodeAt(0)),r=Uint8Array.from(atob(t.self_keys.privateKey),a=>a.charCodeAt(0)),s=await window.crypto.subtle.importKey("spki",n.buffer,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),i=await window.crypto.subtle.importKey("pkcs8",r.buffer,{name:"RSA-OAEP",hash:"SHA-256"},!0,["decrypt"]),o={publicKey:s,privateKey:i},c=new e(o);for(let[a,l]of Object.entries(t.sessions))c.sessions[a]=await A.deserialize(l);return c}};var M=!0,z=!1,y=null;w.init().then(e=>{y=e,z=!0});function W(e,t){document.hidden&&Notification.permission==="granted"&&new Notification(e,{body:t})}function v(e,t,n){return function(){e.lastRenderedIndex=0,m.innerHTML="",e.room=t,console.log("Changed room to:",t),e.messages[t]=e.messages[t]||[],e.servers.forEach(function(s){let i=document.getElementById("server_"+s.id);i&&i.classList.remove("selected")}),n&&n.classList.add("selected"),V(e.db,"messages").then(s=>{console.log(s);let i=s.filter(o=>o.id&&o.id.startsWith(e.room+"--"));console.log(s,i),e.messages[e.room].push(...i),e.messages[e.room].sort((o,c)=>o.timestamp-c.timestamp),e.reTick=!0}),e.reTick=!0;let r=function(){if(!z)return setTimeout(r,10);p.join(e),p.crypto_request(e)};r()}}typeof window.send!="function"&&(console.warn("send() not defined. Using mock send."),window.send=function(e,t,n,r){console.debug("Mock send triggered with:",[e,t,n,r])});function _(e,t,n,r,s=void 0,i=[]){if(typeof s>"u"&&(s=!0),s&&z){let o=[],c=i.map(a=>{let l=a.encrypt(JSON.stringify(e)),d=a.encrypt(JSON.stringify(t)),I=a.encrypt(JSON.stringify(n)),S=a.encrypt(JSON.stringify(r));return Promise.all([l,d,I,S]).then(([P,g,R,G])=>{let J=b(P),F=b(g),q=b(R),$=b(G);o.push([J,F,q,$,a.id])})});Promise.all(c).then(()=>{let a=JSON.stringify(o);_(a,null,null,null,!1)})}else window.send(e,t,n,r),window.get(e,t,n,r)}function h(e,t){localStorage.setItem(e,JSON.stringify(t))}function C(e,t){let n=localStorage.getItem(e);if(n)try{return JSON.parse(n)}catch(r){return console.error("Error parsing JSON for key ".concat(e,":"),r),t}return t}function Z(e,t,n,r){return new Promise((s,i)=>{let c=e.transaction(t,"readwrite").objectStore(t);console.log(r,n);let a=c.put(n,r);a.onsuccess=()=>s(),a.onerror=()=>i(a.error)})}function V(e,t){return new Promise((n,r)=>{let o=e.transaction(t,"readonly").objectStore(t).getAll();o.onsuccess=()=>n(o.result),o.onerror=()=>r(o.error)})}function x(e){let t=atob(e),n=t.length,r=new Uint8Array(n);for(let s=0;s<n;s++)r[s]=t.charCodeAt(s);return r.buffer}function b(e){let t=new Uint8Array(e),n="";for(let r=0;r<t.length;r++)n+=String.fromCharCode(t[r]);return btoa(n)}var p={message:function(e,t,n){if(typeof t!="string"&&(t=JSON.stringify(t)),t.length>2**12){console.warn("Message too long, not sending.");return}let r=Date.now(),s=`${e.room}--${crypto.randomUUID()}-${crypto.randomUUID()}`,i=M&&n?n.map(o=>y.get_session(o)).filter(o=>o):[];_(0,JSON.stringify(e.account),[r,t,s],e.room,M,i)},ping:function(e,t){let n=M&&t?t.map(r=>y.get_session(r)).filter(r=>r):[];_(1,JSON.stringify(e.account),Date.now(),e.room,!0,n)},join:function(e){_(2,JSON.stringify(e.account),Date.now(),e.room,!1),p.crypto_request(e)},crypto:function(e,t){typeof t!="string"&&(t=JSON.stringify(t)),_(255,JSON.stringify(e.account),t,e.room,!1)},crypto_request:function(e){console.debug("Asking for keys"),p.crypto(e,{type:"KEYrequest",id:e.account.id})},crypto_response:function(e){console.debug("sending key"),z&&typeof e.account<"u"?window.crypto.subtle.exportKey("spki",y.self_keys.publicKey).then(t=>{p.crypto(e,{type:"KEYresponse",id:e.account.id,public:b(t)})}):setTimeout(p.crypto_response,100,[e])},base:function(e,t,n,r,s){window.send(t,n,r,s)},bind:function(e){let t={};return Object.entries(p).forEach(([n,r])=>{t[n]=function(...s){r(e,...s)}}),t}},u={message:function(e,t,n,r){var s=n[0],i=n[1],o=n[2];console.debug("Received message in room ".concat(r,":"),{timestamp:s,account:t,message:i}),W("Zap Messenger:  "+t.name+" sent you a message!",i);let c={timestamp:s,account:t,content:i,id:o};e.messages[r].push(c),Z(e.db,"messages",c)},ping:function(e,t,n,r){Object.prototype.hasOwnProperty.call(e.online,r)||(e.online[r]=[]);let s=e.online[r].filter(function(l){l.account.id==t.id});s.length==0&&(s=[{account:t,last:2e4,list:[],avg:Date.now()}]);let i=s[0];var o=i.list,c=i.last;c=Date.now()-n,o.push(c),o.length>10&&o.shift();let a=0;o.forEach(function(l){a+=l}),a/=o.length,e.online[r].unshift({account:t,last:n,list:o,avg:a})},join:function(e,t,n,r){u.ping(e,t,n,r)},crypto:function(e,t,n,r){if(typeof n=="string")try{n=JSON.parse(n)}catch(s){console.error("Invalid JSON crypto:",s.message,n);return}if(!n.type){console.warn("No type in crypto message:",n);return}if(n.version>w.version&&(console.warn("Other user is on a newer version of the cryptography manager:",n.version,">",w.version),console.warn("Some features may not work as expected and may cause glitches.")),n.type=="KEYrequest")console.debug("Got key request from "+t.id),p.crypto_response(e,t);else if(n.type=="KEYresponse")if(n.public&&n.public!="E2EE DENIED"){console.debug("Got key from "+t.id);let s=y.add_session(t.id,n.public)}else console.warn("User ".concat(t.id," denied sending their public key."));else console.warn("Unknown crypto message type:",n)},all:async function(e,t,n,r,s){if(n==null){let o=JSON.parse(t);for(let c=0;c<o.length;c++){let a=o[c];if(a[4]==e.account.id)return t=JSON.parse(await y.decrypt(x(a[0]))),n=JSON.parse(await y.decrypt(x(a[1]))),r=JSON.parse(await y.decrypt(x(a[2]))),s=JSON.parse(await y.decrypt(x(a[3]))),await u.all(e,t,n,r,s)}console.warn("No block for us in encrypted message, ignoring.");return}if(!e)return;e.messages[s]||(e.messages[s]=[]);let i;try{i=JSON.parse(n)}catch(o){console.error("Invalid JSON acc:",o.message,n);return}t==0?u.message(e,i,r,s):t==1?u.ping(e,i,r,s):t==2?u.join(e,i,r,s):t==255?u.crypto(e,i,r,s):console.warn(`${t} is a unknown message type`),e.reTick=!0},bind:function(e){let t={};return t.message=(...n)=>{u.message(e,...n)},t.ping=(...n)=>{u.ping(e,...n)},t.join=(...n)=>{u.join(e,...n)},t.crypto=(...n)=>{u.crypto(e,...n)},t.all=(...n)=>{u.all(e,...n)},t}};function Q(e){e.online[e.room]||(e.online[e.room]=[]),p.ping(e,window.zap_global.online[window.zap_global.room].map(r=>r.account.id)),Array.prototype.slice.call(E.children).forEach(function(r){E.removeChild(r).remove()});let t=Date.now();e.online[e.room].sort(function(r,s){return r.account.name.localeCompare(s.account.name,void 0,{sensitivity:"base"})});let n=new Set;e.online[e.room]=e.online[e.room].filter(function(r){return n.has(r.account.id)?!1:(n.add(r.account.id),!0)}),e.online[e.room].forEach(function(r){if(r.last-t+65e3>0){let s=document.createElement("div");s.className="user_status";let i=document.createElement("div");i.style.cssText="border-radius:9999px; border-width:2px; width:15px; height:15px; "+(r.avg<900?"background-color: green;":r.avg<3e4?"background-color: yellow;":"background-color: red;"),s.appendChild(i);let o=document.createElement("p");o.innerText=r.account.name,o.style.margin="5px",o.style.marginLeft="10px",s.appendChild(o),E.appendChild(s)}})}function X(e){if(console.log("A"),!e.reTick)return;if(e.reTick=!1,!N){console.warn("Main div not found, reloading page to avoid conflicts."),location.reload();return}let t=e.messages[e.room]||[];console.log(t);let n=e.lastRenderedIndex;for(let r=n;r<Math.min(t.length,n+100);r++){let s=t[r];try{let i=document.createElement("div");i.className="msg",i.id="msg_"+s.id,i.innerHTML=`<strong>${s.account.name}</strong> 
            <span class="timestamp">${new Date(s.timestamp).toLocaleTimeString()}</span><br>`;let o=document.createElement("div");o.innerHTML=s.content,i.appendChild(o),m.appendChild(i),e.lastRenderedIndex=t.length,m.scrollHeight-m.scrollTop-m.clientHeight<=200&&(m.scrollTop=m.scrollHeight)}catch(i){console.log("Failed to render message",s,i)}}e.servers.forEach(function(r,s){let i=document.getElementById("server_"+r.id),o=`${r.img?`<img src="${r.img}" alt="${r.nickname}">`:""} ${r.nickname}`;i?(i.innerHTML=o,i.onclick=v(e,r.id,i)):(i=document.createElement("div"),i.className="server",i.id="server_"+r.id,i.innerHTML=o,i.onclick=v(e,r.id,i),L.insertBefore(i,L.lastChild))}),N.addEventListener("contextmenu",function(r){let i=r.target.closest('[id^="server_"]');if(i&&r.button===2){r.preventDefault();let o=i.id.replace("server_",""),c=0;for(let a of e.servers){if(a.id===o)break;c++}if(c===e.servers.length&&(c=-1),c!==-1){let a=e.servers.splice(c,1)[0];h("servers",e.servers),document.getElementById("servers_div").removeChild(i),console.log(`Server ${a.nickname} removed.`),e.room===o&&(e.room=e.servers.length>0?e.servers[0].id:"1",e.lastRenderedIndex=0,H.innerHTML=""),document.querySelectorAll(".server").forEach(d=>d.classList.remove("selected"));let l=document.getElementById("server_"+e.room);l&&l.classList.add("selected")}return}})}function D(e){let t={};return t.onTick=function(){X(e)},t.onPing=function(){Q(e)},t}var O=class{element;theme;constructor(t,n="light"){typeof t=="string"?this.element=document.querySelector(t):this.element=t,this.theme=n;let r=document.createElement("div");r.style.width="100%",r.style.height="10%",r.style.backgroundColor=n=="light"?"#f0f0f0":"#2e2e2e",r.style.display="flex",r.style.alignItems="center",r.style.padding="0 10px",r.style.boxSizing="border-box",this.element.appendChild(r);let s=document.createElement("button");s.innerHTML="<b>B</b>",s.style.marginRight="10px",s.onclick=()=>{document.execCommand("bold")},r.appendChild(s);let i=document.createElement("button");i.innerHTML="<i>I</i>",i.style.marginRight="10px",i.onclick=()=>{document.execCommand("italic")},r.appendChild(i);let o=document.createElement("button");o.innerHTML="<u>U</u>",o.style.marginRight="10px",o.onclick=()=>{document.execCommand("underline")},r.appendChild(o);let c=document.createElement("button");c.innerHTML="<s>S</s>",c.style.marginRight="10px",c.onclick=()=>{document.execCommand("strikeThrough")},r.appendChild(c);let a=document.createElement("input");a.type="file",a.accept="image/*",a.style.display="none",a.onchange=()=>{let I=a.files[0],S=new FileReader;S.onload=P=>{let g=document.createElement("img");g.src=P.target.result,g.style.maxWidth="100%",g.style.height="auto",this.element.querySelector("#textinput").appendChild(g)},S.readAsDataURL(I)},r.appendChild(a);let l=document.createElement("button");l.innerHTML="\u{1F4F7}",l.style.marginRight="10px",l.onclick=()=>a.click(),r.appendChild(l);let d=document.createElement("div");d.contentEditable="true",d.id="textinput",d.style.width="100%",d.style.height="90%",d.style.outline="none",d.style.overflowY="auto",d.style.padding="10px",d.style.boxSizing="border-box",d.style.backgroundColor=n=="light"?"white":"#1e1e1e",d.style.color=n=="light"?"black":"white",d.style.fontFamily="Arial, sans-serif",d.style.fontSize="14px",this.element.appendChild(d)}getHTML(){return this.element.querySelector("#textinput").innerHTML}setHTML(t){this.element.querySelector("#textinput").innerHTML=t}destroy(){this.element.innerHTML=""}};window.zap_global={messages:{},room:"1",servers:C("servers",[{id:"1",nickname:"General",img:""}]),account:C("account",{}),reTick:!0,lastRenderedIndex:0,dark:!C("dark",window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches),online:{},editor:void 0,db:void 0};var ee=function(t){let n={};for(let[r,s]of t){let i=r[0],o=r.slice(1);n[o]=[i,s]}return Object.entries(n).map(([r,[s,i]])=>[s+r,i])},K=window.indexedDB.open("ZapMessengerRW",1);K.onsuccess=function(e){window.zap_global.db=K.result};K.onupgradeneeded=e=>{let t=K.result,n=[];switch(e.oldVersion){case 0:n.push(["+ messages",{keyPath:"id",autoIncrement:!0}]);case 1:n.push(["-+ messages",{keyPath:"id",autoIncrement:!1}])}n=ee(n),n.forEach(([r,s])=>{let[i,o]=r.split(" ",2);i==="+"?t.objectStoreNames.contains(o)?console.warn(`Cannot add ${o} because it already exists`):t.createObjectStore(o,s):i==="-"?t.objectStoreNames.contains(o)?t.deleteObjectStore(o):console.warn(`Cannot remove ${o} because it doesn't exist`):i==="-+"&&(t.objectStoreNames.contains(o)&&t.deleteObjectStore(o),t.createObjectStore(o,s))})};window.zap_global.account.name||re();var{onPing:te,onTick:ne}=D(window.zap_global);Notification.permission==="default"&&Notification.requestPermission();function re(){let e=null;for(;!e||e.trim().length===0;)e=prompt("Enter your name to continue:"),e===null&&alert("You must enter a name to use the chat.");window.zap_global.account={name:e.trim(),id:crypto.randomUUID()},h("account",window.zap_global.account)}B.onclick=function(){if(window.zap_global.editor){let e=window.zap_global.editor.getHTML();window.zap_global.editor.setHTML("");let t=window.zap_global.online[window.zap_global.room].map(n=>n.account.id);console.log("Sending to targets:",t),p.message(window.zap_global,e,t)}};j.onclick=function(){let e,t,n;for(;!e;)e=prompt("Enter server name:");for(;!t;)t=prompt("Enter server ID:");n=prompt("Enter server image URL (optional):",""),window.zap_global.servers.push({id:t,nickname:e,img:n}),window.zap_global.reTick=!0,h("servers",window.zap_global.servers)};f.classList.add("closed");U.onclick=function(){f.classList.contains("open")?(f.classList.remove("open"),f.classList.add("closed")):(f.classList.remove("closed"),f.classList.add("open"))};var k=document.createElement("div");k.classList.add("button");k.onclick=function(){window.zap_global.dark=!window.zap_global.dark,h("dark",window.zap_global.dark),window.zap_global.dark?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark");let e="";window.zap_global.editor&&(e=window.zap_global.editor.getHTML(),window.zap_global.editor.destroy()),window.zap_global.editor=new O("div#msg_input",window.zap_global.dark?"dark":"light"),window.zap_global.editor.setHTML(e)};var T=document.createElement("img");T.src="https://cdn-icons-png.flaticon.com/512/12377/12377255.png ";T.style.height="20px";T.style.width="20px";k.appendChild(T);f.appendChild(k);function se(){k.click(),setInterval(ne,250);let e=document.createElement("div");v(window.zap_global,"1",e)(),e.remove()}document.title="Zap Messenger Rewritten";var ie=setInterval((function(){document.readyState=="complete"&&(clearInterval(ie),se())}),100);setInterval(te,500);window.get=u.bind(window.zap_global).all;})();
//# sourceMappingURL=main.js.map
