(()=>{"use strict";const e={messages:{},room:"1",servers:[],account:{name:"You",id:65565*Math.random()}};let n=0;function t(e,n){localStorage.setItem(e,JSON.stringify(n))}function o(e,n){n=n||null;const t=localStorage.getItem(e);if(t)try{return JSON.parse(t)}catch(t){return console.error(`Error parsing JSON for key ${e}:`,t),n}return n}e.messages=o("messages",{}),e.servers=o("servers",[{id:"1",nickname:"General",img:""}]),e.account=o("account",{}),e.account.name||function(){let n=null;for(;!n||0===n.trim().length;)n=prompt("Enter your name to continue:"),null===n&&alert("You must enter a name to use the chat.");e.account={name:n.trim(),id:Math.floor(65565*Math.random())},t("account",e.account)}();let r=document.getElementById("chat_div");if(r)console.warn("Chat div already exists, reloading page to avoid conflicts."),location.reload();else{for(let e=0;e<document.body.children.length;e++)document.body.children[e].style.display="none";document.body.insertAdjacentHTML("beforeend",'<div id="chat_div">\n    <div id="servers_div">\n        <div class="server" id="serveradd">\n            <img src="https://cdn-icons-png.flaticon.com/512/1237/1237946.png" alt="Add Server" />\n        </div>\n    </div>\n    <div id="chat_inner_div">\n        <div id="msg_container"></div>\n        <div id="message_input_div">\n            <textarea id="msg_input" rows="4" maxlength="2048" style="width: 100%; overflow: auto;"\n                placeholder="Enter up to 2048 characters...">\n            </textarea>\n            <button id="msg_send">\n                <img id="msg_send_img" src="https://cdn-icons-png.flaticon.com/512/3682/3682321.png" alt="Send" />\n            </button>\n        </div>\n    </div>\n    <div id="info_floater"></div>\n</div>');const e=document.createElement("style");e.textContent="#servers_div {\n    position: absolute;\n    top: 0px;\n    left: 0px;\n    width: 75px;\n    height: 100%;\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    background-color: #4f4f4f;\n    overflow-y: scroll;\n}\n\n#info_floater {\n    position: absolute;\n    bottom: 0px;\n    left: 0px;\n    max-width: 75px;\n    z-index: 1000;\n    background-color: rgba(0, 0, 0, 0.25);\n    color: rgba(105, 105, 105, 0.75);\n    font-family: Arial, sans-serif;\n}\n\n.server img {\n    width: 100%;\n    aspect-ratio: 1 / 1;\n    border-radius: 9999px;\n    object-fit: cover;\n    object-position: center;\n}\n\n.server {\n    width: 100%;\n    aspect-ratio: 1 / 1;\n    padding: 10px;\n    box-sizing: border-box;\n    border-radius: 9999px;\n    background-color: #444;\n    margin: 5px 0;\n    color: white;\n    text-align: center;\n    display: flex;\n    align-items: column;\n    justify-content: center;\n    cursor: pointer;\n}\n\n.server.selected {\n    outline: 2px solid limegreen;\n}\n\n#chat_inner_div {\n    position: absolute;\n    top: 0px;\n    right: 0px;\n    width: calc(100% - 75px);\n    height: 100%;\n    overflow-y: hidden;\n    background-color: white;\n    display: flex;\n    align-items: left;\n    flex-direction: column;\n}\n\n#msg_container {\n    width:100;\n    height:calc(100% - 50px);\n    overflow-y: scroll;\n}\n\n.msg {\n    width: 100%;\n    padding: 10px;\n    box-sizing: border-box;\n    border-radius: 9999px;\n    background-color: #f1f1f1;\n    margin: 5px 0;\n    position: relative;\n    font-family: Arial, sans-serif;\n    color: #333;\n}\n\n#message_input_div {\n    position: absolute;\n    bottom: 0px;\n    right: 0px;\n    width: 100%;\n    height: 50px;\n    border-radius: 9999px;\n    display: flex;\n    align-items: center;\n    flex-direction: row;\n}\n\n#msg_input {\n    margin-right: 10px;\n    width: 100%;\n    height: 100%;\n    border-radius: 9999px;\n}\n\n#msg_send {\n    margin-right: 10px;\n    aspect-ratio: 1 / 1;\n    height: 100%;\n    border-radius: 50%;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    padding: 0;\n    border: none;\n    background: none;\n    cursor: pointer;\n}\n\n#msg_send_img {\n    width: 100%;\n    height: 100%;\n    border-radius: 50%;\n    object-fit: cover;\n    object-position: center;\n}\n\n#chat_div {\n    position: absolute;\n    top: 0px;\n    left: 0px;\n    width: 100%;\n    height: 100%;\n    z-index: 0;\n    background-color: #777;\n}",document.head.appendChild(e)}function i(n,o,r,i){let s,a;e.messages[i]||(e.messages[i]=[]);try{s=JSON.parse(r)}catch(e){return void console.error("Invalid JSON msg:",e.message)}try{a=JSON.parse(o)}catch(e){return void console.error("Invalid JSON acc:",e.message)}a&&s?(console.log(`Received message in room ${i}:`,{timestamp:n,parsed_account:a,parsed_message:s}),e.messages[i].push({timestamp:n,account:a,content:s}),t("messages",e.messages)):console.error("Parsed account or message is null",o,r)}r=document.getElementById("chat_div");const s=document.getElementById("msg_input"),a=document.getElementById("msg_send"),c=document.getElementById("chat_inner_div"),d=document.getElementById("msg_container"),l=document.getElementById("servers_div"),m=document.getElementById("serveradd"),g=document.getElementById("info_floater");function u(t,o){return function(){n=0,d.innerHTML="",e.room=t,console.log("Changed room to:",t),e.messages[t]=e.messages[t]||[],e.servers.forEach((function(e){let n=document.getElementById("server_"+e.id);n&&n.classList.remove("selected")})),o&&o.classList.add("selected")}}s.innerText="",g.innerHTML="<strong>v1.0.0</strong><br>\n    <strong>Build:</strong> 15ambabjyne<br>",a.onclick=function(){let n=s.value;var t,o,r,a;n&&(s.value="",t=Date.now(),o=JSON.stringify(e.account),r=JSON.stringify([{type:"text",data:n}]),a=e.room,send(t,o,r,a),i(t,o,r,a))},m.onclick=function(){let n,o,r;for(;!n;)n=prompt("Enter server name:");for(;!o;)o=prompt("Enter server ID:");r=prompt("Enter server image URL (optional):",""),e.servers.push({id:o,nickname:n,img:r}),t("servers",e.servers)},r.addEventListener("contextmenu",(function(o){const r=o.target.closest('[id^="server_"]');if(r&&2===o.button){o.preventDefault();const i=r.id.replace("server_",""),s=e.servers.findIndex((e=>e.id===i));if(-1!==s){const o=e.servers.splice(s,1)[0];t("servers",e.servers),document.getElementById("servers_div").removeChild(r),console.log(`Server ${o.nickname} removed.`),e.room===i&&(e.room=e.servers.length>0?e.servers[0].id:"1",n=0,c.innerHTML=""),document.querySelectorAll(".server").forEach((e=>e.classList.remove("selected")));const a=document.getElementById("server_"+e.room);a&&a.classList.add("selected")}}})),window.get=i,requestAnimationFrame((function t(){if(!r)return console.warn("Main div not found, reloading page to avoid conflicts."),void location.reload();const o=e.messages[e.room]||[];for(let e=n;e<o.length;e++){let t=o[e];console.log(t);let r=document.createElement("div");r.className="msg",r.id="msg_"+e,r.innerHTML=`<strong>${t.account.name}</strong> \n            <span class="timestamp">${new Date(t.timestamp).toLocaleTimeString()}</span><br>`,t.content.forEach((e=>{if("text"===e.type){const n=document.createElement("pre");n.textContent=e.data,r.appendChild(n)}else if("image"===e.type){const n=document.createElement("img");try{const t=new URL(e.data,window.location.origin);n.src=t.href,r.appendChild(n)}catch(n){console.warn("Invalid image URL:",e.data)}}else if("video"===e.type){const n=document.createElement("video");try{const t=new URL(e.data,window.location.origin);n.src=t.href,n.controls=!0,r.appendChild(n)}catch(n){console.warn("Invalid video URL:",e.data)}}})),d.appendChild(r),n=o.length,d.scrollHeight-d.scrollTop-d.clientHeight<=200&&(d.scrollTop=d.scrollHeight)}e.servers.forEach((function(e,n){let t=document.getElementById("server_"+e.id),o=`${e.img?`<img src="${e.img}" alt="${e.nickname}">`:""} ${e.nickname}`;t?(t.innerHTML=o,t.onclick=u(e.id,t)):(t=document.createElement("div"),t.className="server",t.id="server_"+e.id,t.className="server",t.innerHTML=o,t.onclick=u(e.id,t),l.insertBefore(t,l.lastChild))})),requestAnimationFrame(t)}))})();