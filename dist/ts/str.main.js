(()=>{var O=document.getElementById("msg_send"),k=document.getElementById("status_bar"),V=document.getElementById("msg_input"),P=document.getElementById("chat_inner_div"),p=document.getElementById("msg_container"),L=document.getElementById("servers_div"),Q=document.getElementById("info_floater"),B=document.getElementById("serveradd"),X=document.getElementById("typing"),C=document.getElementById("chat_div"),ee=document.getElementById("css"),g=document.getElementById("settings_menu"),H=document.getElementById("settings_button");var M=class{static version=1;id;other_key;self_keys;constructor(t,n,s){this.id=t,this.other_key=n,this.self_keys=s}async encrypt(t){let n=new TextEncoder().encode(t);return await window.crypto.subtle.encrypt({name:"RSA-OAEP"},this.other_key,n)}async decrypt(t){let n=await window.crypto.subtle.decrypt({name:"RSA-OAEP"},this.self_keys.privateKey,t);return new TextDecoder().decode(n)}};async function R(){let e=await window.crypto.subtle.generateKey({name:"RSA-OAEP",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:"SHA-256"},!0,["encrypt","decrypt"]),t=await window.crypto.subtle.exportKey("spki",e.publicKey),n=await window.crypto.subtle.exportKey("pkcs8",e.privateKey);return console.log("Public Key:",btoa(String.fromCharCode(...new Uint8Array(t)))),console.log("Private Key:",btoa(String.fromCharCode(...new Uint8Array(n)))),{publicKey:t,privateKey:n,keyPair:e}}var w=class e{static version=1;self_keys;sessions={};constructor(t){this.self_keys=t}static async init(){let{keyPair:t}=await R();return new e(t)}get_session(t){return t in this.sessions?this.sessions[t]:null}add_session(t,n){if(t in this.sessions)return this.sessions[t];let s=Uint8Array.from(atob(n),r=>r.charCodeAt(0));return window.crypto.subtle.importKey("spki",s.buffer,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]).then(r=>{let i=new M(t,r,this.self_keys);return this.sessions[t]=i,i})}async decrypt(t){let n=await window.crypto.subtle.decrypt({name:"RSA-OAEP"},this.self_keys.privateKey,t);return new TextDecoder().decode(n)}};var y=null;w.init().then(e=>{y=e});var A=!0;function J(e,t){document.hidden&&Notification.permission==="granted"&&new Notification(e,{body:t})}function N(e,t,n){return function(){e.lastRenderedIndex=0,p.innerHTML="",e.room=t,console.log("Changed room to:",t),e.messages[t]=e.messages[t]||[],e.servers.forEach(function(s){let r=document.getElementById("server_"+s.id);r&&r.classList.remove("selected")}),n&&n.classList.add("selected"),e.reTick=!0}}typeof window.send!="function"&&(console.warn("send() not defined. Using mock send."),window.send=function(e,t,n,s){console.debug("Mock send triggered with:",[e,t,n,s])});function _(e,t,n,s,r=void 0,i=[]){if(typeof r>"u"&&(r=A),r){let o=[];i.forEach(a=>{let c=a.encrypt(JSON.stringify(e)),d=a.encrypt(JSON.stringify(t)),l=a.encrypt(JSON.stringify(n)),T=a.encrypt(JSON.stringify(s));Promise.all([c,d,l,T]).then(([b,I,f,G])=>{o.push([b,I,f,G,a.id])})}),_(o,null,null,null,!1)}else window.send(e,t,n,s),window.get(e,t,n,s)}function h(e,t){localStorage.setItem(e,JSON.stringify(t))}function E(e,t){let n=localStorage.getItem(e);if(n)try{return JSON.parse(n)}catch(s){return console.error("Error parsing JSON for key ".concat(e,":"),s),t}return t}function F(e,t,n,s){return new Promise((r,i)=>{let c=e.transaction(t,"readwrite").objectStore(t).put(s,n);c.onsuccess=()=>r(),c.onerror=()=>i(c.error)})}function D(e,t){return new Promise((n,s)=>{let o=e.transaction(t,"readonly").objectStore(t).getAll();o.onsuccess=()=>n(o.result),o.onerror=()=>s(o.error)})}var u={message:function(e,t,n){if(typeof t!="string"&&(t=JSON.stringify(t)),t.length>2**12){console.warn("Message too long, not sending.");return}let s=Date.now(),r=`${e.room}/"${crypto.randomUUID()}-${crypto.randomUUID()}`,i=A&&n?n.map(o=>y.get_session(o)).filter(o=>o):[];_(0,JSON.stringify(e.account),[s,t,r],e.room,void 0,i)},ping:function(e,t){let n=A&&t?t.map(s=>y.get_session(s)).filter(s=>s):[];_(1,JSON.stringify(e.account),Date.now(),e.room,!0,n)},join:function(e){_(2,JSON.stringify(e.account),Date.now(),e.room,!1),u.crypto_request(e)},crypto:function(e,t){typeof t!="string"&&(t=JSON.stringify(t)),_(255,JSON.stringify(e.account),t,e.room,!1)},crypto_request:function(e){u.crypto(e,{type:"KEYrequest",id:e.account.id})},crypto_response:function(e){window.crypto.subtle.exportKey("spki",y.self_keys.publicKey).then(t=>{u.crypto(e,{type:"KEYresponse",id:e.account.id,public:btoa(String.fromCharCode(...new Uint8Array(t)))})})},base:function(e,t,n,s,r){window.send(t,n,s,r)},bind:function(e){let t={};return Object.entries(u).forEach(([n,s])=>{t[n]=function(...r){s(e,...r)}}),t}},m={message:function(e,t,n,s){var r=n[0],i=n[1],o=n[2];console.debug("Received message in room ".concat(s,":"),{timestamp:r,account:t,message:i}),J("Zap Messenger:  "+t.name+" sent you a message!",i);let a={timestamp:r,account:t,content:i,id:o};e.messages[s].push(a),F(e.db,"messages",o,a)},ping:function(e,t,n,s){Object.prototype.hasOwnProperty.call(e.online,s)||(e.online[s]=[]);let r=e.online[s].filter(function(d){d.account.id==t.id});r.length==0&&(r=[{account:t,last:2e4,list:[],avg:Date.now()}]);let i=r[0];var o=i.list,a=i.last;a=Date.now()-n,o.push(a),o.length>10&&o.shift();let c=0;o.forEach(function(d){c+=d}),c/=o.length,e.online[s].unshift({account:t,last:n,list:o,avg:c})},join:function(e,t,n,s){m.ping(e,t,n,s)},crypto:function(e,t,n,s){if(typeof n=="string")try{n=JSON.parse(n)}catch(r){console.error("Invalid JSON crypto:",r.message,n);return}if(!n.type){console.warn("No type in crypto message:",n);return}if(n.version>w.version&&(console.warn("Other user is on a newer version of the cryptography manager:",n.version,">",w.version),console.warn("Some features may not work as expected and may cause glitches.")),n.type=="KEYrequest")console.log("Received key request from",t.id),u.crypto_response(e,t);else if(n.type=="KEYresponse")if(console.log("Received key response from",t.id,n),n.public&&n.public!="E2EE DENIED"){let r=y.add_session(t.id,n.public)}else console.warn("User ".concat(t.id," denied sending their public key."));else console.warn("Unknown crypto message type:",n)},all:async function(e,t,n,s,r){if(console.log("type:",t,"account:",n,"content:",s,"room:",r),!n){for(let o=0;o<t.length;o++){let a=t[o];if(a[4]==e.account.id){t=JSON.parse(await y.decrypt(a[0])),n=JSON.parse(await y.decrypt(a[1])),s=JSON.parse(await y.decrypt(a[2])),r=JSON.parse(await y.decrypt(a[3])),console.log("Decrypted message:",{type:t,stringed_account:n,content:s,room:r});break}}if(!n){console.warn("No block for us in encrypted message, ignoring.");return}}if(!e)return;e.messages[r]||(e.messages[r]=[]);let i;try{i=JSON.parse(n)}catch(o){console.error("Invalid JSON acc:",o.message,n);return}t==0?m.message(e,i,s,r):t==1?m.ping(e,i,s,r):t==2?m.join(e,i,s,r):t==255?m.crypto(e,i,s,r):console.warn(`${t} is a unknown message type`)},bind:function(e){let t={};return t.message=(...n)=>{m.message(e,...n)},t.ping=(...n)=>{m.ping(e,...n)},t.join=(...n)=>{m.join(e,...n)},t.crypto=(...n)=>{m.crypto(e,...n)},t.all=(...n)=>{m.all(e,...n)},t}};function q(e){e.online[e.room]||(e.online[e.room]=[]),u.ping(e,window.zap_global.online[window.zap_global.room].map(s=>s.account.id)),Array.prototype.slice.call(k.children).forEach(function(s){k.removeChild(s).remove()});let t=Date.now();e.online[e.room].sort(function(s,r){return s.account.name.localeCompare(r.account.name,void 0,{sensitivity:"base"})});let n=new Set;e.online[e.room]=e.online[e.room].filter(function(s){return n.has(s.account.id)?!1:(n.add(s.account.id),!0)}),e.online[e.room].forEach(function(s){if(s.last-t+65e3>0){let r=document.createElement("div");r.className="user_status";let i=document.createElement("div");i.style.cssText="border-radius:9999px; border-width:2px; width:15px; height:15px; "+(s.avg<900?"background-color: green;":s.avg<3e4?"background-color: yellow;":"background-color: red;"),r.appendChild(i);let o=document.createElement("p");o.innerText=s.account.name,o.style.margin="5px",o.style.marginLeft="10px",r.appendChild(o),k.appendChild(r)}})}function U(e){if(console.log("A"),!e.reTick)return;if(e.reTick=!1,!C){console.warn("Main div not found, reloading page to avoid conflicts."),location.reload();return}let t=e.messages[e.room]||[],n=e.lastRenderedIndex;for(let s=n;s<Math.min(t.length,n+100);s++){let r=t[s];try{let i=document.createElement("div");i.className="msg",i.id="msg_"+s,i.innerHTML=`<strong>${r.account.name}</strong> 
            <span class="timestamp">${new Date(r.timestamp).toLocaleTimeString()}</span><br>`;let o=document.createElement("div");o.innerHTML=r.content,i.appendChild(o),p.appendChild(i),e.lastRenderedIndex=t.length,p.scrollHeight-p.scrollTop-p.clientHeight<=200&&(p.scrollTop=p.scrollHeight)}catch(i){console.log("Failed to render message",r,i)}}e.servers.forEach(function(s,r){let i=document.getElementById("server_"+s.id),o=`${s.img?`<img src="${s.img}" alt="${s.nickname}">`:""} ${s.nickname}`;i?(i.innerHTML=o,i.onclick=N(e,s.id,i)):(i=document.createElement("div"),i.className="server",i.id="server_"+s.id,i.innerHTML=o,i.onclick=N(e,s.id,i),L.insertBefore(i,L.lastChild))}),C.addEventListener("contextmenu",function(s){let i=s.target.closest('[id^="server_"]');if(i&&s.button===2){s.preventDefault();let o=i.id.replace("server_",""),a=0;for(let c of e.servers){if(c.id===o)break;a++}if(a===e.servers.length&&(a=-1),a!==-1){let c=e.servers.splice(a,1)[0];h("servers",e.servers),document.getElementById("servers_div").removeChild(i),console.log(`Server ${c.nickname} removed.`),e.room===o&&(e.room=e.servers.length>0?e.servers[0].id:"1",e.lastRenderedIndex=0,P.innerHTML=""),document.querySelectorAll(".server").forEach(l=>l.classList.remove("selected"));let d=document.getElementById("server_"+e.room);d&&d.classList.add("selected")}return}})}function K(e){let t={};return t.onTick=function(){U(e)},t.onPing=function(){q(e)},t}var z=class{element;theme;constructor(t,n="light"){typeof t=="string"?this.element=document.querySelector(t):this.element=t,this.theme=n;let s=document.createElement("div");s.style.width="100%",s.style.height="10%",s.style.backgroundColor=n=="light"?"#f0f0f0":"#2e2e2e",s.style.display="flex",s.style.alignItems="center",s.style.padding="0 10px",s.style.boxSizing="border-box",this.element.appendChild(s);let r=document.createElement("button");r.innerHTML="<b>B</b>",r.style.marginRight="10px",r.onclick=()=>{document.execCommand("bold")},s.appendChild(r);let i=document.createElement("button");i.innerHTML="<i>I</i>",i.style.marginRight="10px",i.onclick=()=>{document.execCommand("italic")},s.appendChild(i);let o=document.createElement("button");o.innerHTML="<u>U</u>",o.style.marginRight="10px",o.onclick=()=>{document.execCommand("underline")},s.appendChild(o);let a=document.createElement("button");a.innerHTML="<s>S</s>",a.style.marginRight="10px",a.onclick=()=>{document.execCommand("strikeThrough")},s.appendChild(a);let c=document.createElement("input");c.type="file",c.accept="image/*",c.style.display="none",c.onchange=()=>{let T=c.files[0],b=new FileReader;b.onload=I=>{let f=document.createElement("img");f.src=I.target.result,f.style.maxWidth="100%",f.style.height="auto",this.element.querySelector("#textinput").appendChild(f)},b.readAsDataURL(T)},s.appendChild(c);let d=document.createElement("button");d.innerHTML="\u{1F4F7}",d.style.marginRight="10px",d.onclick=()=>c.click(),s.appendChild(d);let l=document.createElement("div");l.contentEditable="true",l.id="textinput",l.style.width="100%",l.style.height="90%",l.style.outline="none",l.style.overflowY="auto",l.style.padding="10px",l.style.boxSizing="border-box",l.style.backgroundColor=n=="light"?"white":"#1e1e1e",l.style.color=n=="light"?"black":"white",l.style.fontFamily="Arial, sans-serif",l.style.fontSize="14px",this.element.appendChild(l)}getHTML(){return this.element.querySelector("#textinput").innerHTML}setHTML(t){this.element.querySelector("#textinput").innerHTML=t}destroy(){this.element.innerHTML=""}};window.zap_global={messages:{},room:"1",servers:E("servers",[{id:"1",nickname:"General",img:""}]),account:E("account",{}),reTick:!0,lastRenderedIndex:0,dark:!E("dark",window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches),online:{},editor:void 0,db:void 0};var x=window.indexedDB.open("ZapMessengerRW",1);x.onsuccess=function(e){window.zap_global.db=x.result};x.onupgradeneeded=e=>{let t=x.result,n=[];switch(e.oldVersion){case 0:n.push(["messages",{keyPath:"id",autoIncrement:!0}])}n.forEach(([s,r])=>{t.objectStoreNames.contains(s)||t.createObjectStore(s,r)})};var{onPing:j,onTick:$}=K(window.zap_global);window.zap_global.account.name||Y();Notification.permission==="default"&&Notification.requestPermission();function Y(){let e=null;for(;!e||e.trim().length===0;)e=prompt("Enter your name to continue:"),e===null&&alert("You must enter a name to use the chat.");window.zap_global.account={name:e.trim(),id:crypto.randomUUID()},h("account",window.zap_global.account)}O.onclick=function(){if(window.zap_global.editor){let e=window.zap_global.editor.getHTML();window.zap_global.editor.setHTML("");let t=window.zap_global.online[window.zap_global.room].map(n=>n.account.id);u.message(e,t)}};B.onclick=function(){let e,t,n;for(;!e;)e=prompt("Enter server name:");for(;!t;)t=prompt("Enter server ID:");n=prompt("Enter server image URL (optional):",""),window.zap_global.servers.push({id:t,nickname:e,img:n}),window.zap_global.reTick=!0,h("servers",window.zap_global.servers)};g.classList.add("closed");H.onclick=function(){g.classList.contains("open")?(g.classList.remove("open"),g.classList.add("closed")):(g.classList.remove("closed"),g.classList.add("open"))};var v=document.createElement("div");v.classList.add("button");v.onclick=function(){window.zap_global.dark=!window.zap_global.dark,h("dark",window.zap_global.dark),window.zap_global.dark?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark");let e="";window.zap_global.editor&&(e=window.zap_global.editor.getHTML(),window.zap_global.editor.destroy()),window.zap_global.editor=new z("div#msg_input",window.zap_global.dark?"dark":"light"),window.zap_global.editor.setHTML(e)};var S=document.createElement("img");S.src="https://cdn-icons-png.flaticon.com/512/12377/12377255.png ";S.style.height="20px";S.style.width="20px";v.appendChild(S);g.appendChild(v);function W(){D(window.zap_global.db,"messages").then(e=>{let t=e.filter(n=>{n.id&&n.id.startsWith(window.zap_global.room+"/")});window.zap_global.messages[window.zap_global.room]=t}),v.click(),setInterval($,250)}document.title="Zap Messenger Rewritten";var Z=setInterval((function(){document.readyState=="complete"&&(clearInterval(Z),W(),u.join(window.zap_global),u.crypto_request(window.zap_global))}),100);setInterval(j,500);window.get=m.bind(window.zap_global).all;})();
